<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8' />
  <title>San Francisco Buildings</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.37.0/mapbox-gl.css' rel='stylesheet' />
  <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.1.0/mapbox-gl-geocoder.css'
    type='text/css' />
  <link href='https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css' rel='stylesheet' />
  <link href='https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css' rel='stylesheet' />
  <style>
    body {
      font-size: 1.5em;
      /* currently ems cause chrome bug misinterpreting rems on body element */
      line-height: 1.6;
      font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      color: #222;
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 350px;
      right: 0;
      width: 75%;
    }

    #tableSource {
      position: absolute;
      bottom: 0;
      right: 0;
      z-index: 1;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 5px;
    }

    #header {
      position: relative;
      min-height: 50px;
      background-color: #245f7b;
      color: #fff;
    }

    .brand {
      font-size: 2rem;
      line-height: 50px;
      float:left;
    }

    .datasf-brand {
      font-size: .9em;
      padding-left: 15px;
      background-color: #133140;
    }

    .group:after {
      visibility: hidden;
      display: block;
      content: "";
      clear: both;
      height: 0;
    }

    .nav-links {
      float: right;
      line-height: 50px;
    }

    .nav-links a {
      color: white;
    }

    #geocoder {
      margin-top: 20px;
    }

    #content {
      position: absolute;
      margin-top: 71px;
      bottom: 0;
      left: 0;
      right: 0;
      top: 0;
    }

    #options {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 25%;
      overflow-y: scroll;
    }

    #table {
      position: absolute;
      height: 350px;
      bottom: 0;
      right: 0;
      width: 75%;
      overflow-y: scroll;
      font-size: 90%;
    }

    #table table {
      margin-bottom: 30px;
    }

    #table thead tr {
      vertical-align: bottom;
    }

    #table tbody tr {
      vertical-align: top;
    }

    #table td,
    #table th {
      padding: 0 5px;
    }

    .mapboxgl-popup-content p {
      margin-bottom: 0;
    }

    table {
      border-spacing: 0;
      width: 100%;
      margin-bottom: 0;
    }

    #footer {
      display: none;
      position: absolute;
      bottom: 0;
      min-height: 35px;
      left: 0;
      right: 0;
    }

    .text-center {
      text-align: center;
    }

    button {
      width: 100%;
      margin-bottom: 0;
      margin-top: 1rem;
    }

    #footer .made-in {
      background-color: #245f7b;
      color: #fff;
      padding: 5px 0;
    }

    .switch-field {
      padding: 20px 0;
      overflow: hidden;
    }

    .switch-title {
      margin-bottom: 6px;
    }

    .switch-field input {
      position: absolute !important;
      clip: rect(0, 0, 0, 0);
      height: 1px;
      width: 1px;
      border: 0;
      overflow: hidden;
    }

    .switch-field label {
      float: left;
    }

    .switch-field label {
      display: inline-block;
      width: 60px;
      background-color: #e4e4e4;
      color: rgba(0, 0, 0, 0.6);
      font-size: 14px;
      font-weight: normal;
      text-align: center;
      text-shadow: none;
      padding: 6px 14px;
      margin-bottom: 0;
      border: 1px solid rgba(0, 0, 0, 0.2);
      -webkit-box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3), 0 1px rgba(255, 255, 255, 0.1);
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3), 0 1px rgba(255, 255, 255, 0.1);
      -webkit-transition: all 0.1s ease-in-out;
      -moz-transition: all 0.1s ease-in-out;
      -ms-transition: all 0.1s ease-in-out;
      -o-transition: all 0.1s ease-in-out;
      transition: all 0.1s ease-in-out;
    }

    .switch-field label:hover {
      cursor: pointer;
    }

    .switch-field input:checked+label {
      background-color: #A5DC86;
      -webkit-box-shadow: none;
      box-shadow: none;
    }

    .switch-field label:first-of-type {
      border-radius: 4px 0 0 4px;
    }

    .switch-field label:last-of-type {
      border-radius: 0 4px 4px 0;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      margin-bottom: 0;
      letter-spacing: 0;
      margin-top: 1.5rem;
      font-weight: 500;
    }

    h1 {
      font-size: 2.6rem;
    }

    h2 {
      font-size: 2.0rem;
    }

    h3 {
      font-size: 3.0em;
    }

    h4 {
      font-size: 2.4em;
    }

    h5 {
      font-size: 1.8em;
    }

    h6 {
      font-size: 1.5em;
    }

    #buildingInfo h1 {
      margin-top: 0;
    }

    .info-header h1 {
      border-bottom: thin solid black;
    }

    .inner-margin {
      margin-left: 15px;
      margin-right: 15px;
    }

    .mapboxgl-ctrl-geocoder {
      max-width: none;
      width: 100%;
    }

    table {
      width: 100%;
    }

    table.small-table {
      font-size: 80%;
      margin-top: 10px;
    }

    table.small-table th,
    table.small-table td {
      padding: 0;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    tfoot tr:first-child td {
      border-top: solid black thin;
    }

    table.small-table caption {
      text-align: left;
      font-style: italic;
    }

    td.status_date {
      min-width: 80px;
    }

    tfoot {
      font-style: italic;
    }

    label {
      display: inline;
    }

    ul.not-styled {
      list-style: none;
      margin-bottom: 0;
    }

    ul.not-styled li {
      margin-bottom: 0;
    }

    .table-hidden #map {
      bottom: 0;
    }

    .table-hidden #table {
      display: none;
    }

    .table-hidden #tableSource {
      display: none;
    }

    .table-source {
      font-size: .8em;
    }

    .no-records-message {
      display: none;
      text-align: center;
      font-size: 2em;
      margin-top: 30px;
    }
    .no-records .no-records-message {
      display: block;
    }
    .no-records .table-wrapper {
      display: none;
    }
    .loading-text {
      padding-top: 8px
    }
    .hidden {
      display: none;
    }
    .data-source {
      font-size: .8em;
    }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      border: 0;
    }

    .advisory {
      font-size: .8em;
      font-weight: bold;
      margin-bottom: .4em;
    }
    
    .facility {
      margin-bottom: .4em;
    }
  </style>
  <link href='loading.css' rel='stylesheet' />
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-53975719-3', 'auto');
  ga('send', 'pageview');

  </script>
</head>

<body>
  <div id='header' class='group'>
    <div class='datasf-brand'>
      A prototye application from <a href='https://datasf.org/' target='_blank'>DataSF</a> made with <span class='sr-only'>heart</span><img role='presentation' aria-hidden='true' alt='' src='heart.png' style='height: 12px; width: auto' /> on <a href='https://datasf.org/opendata/' target='_blank'>open data</a>
    </div>
    <div class='inner-margin'>
      <div class='brand'>San Francisco Building Explorer (Demo)</div>
      <div class='nav-links'><a href='https://github.com/DataSF/sf-building-explorer' target='_blank'>Source Code</a> | <a href='https://datasf.org/blog/new-sf-building-footprints-released-with-3d-characteristics/' target='_blank'>About</a></div>
    </div>
  </div>
  <div id='content'>
    <div id='main' class='table-hidden'>
      <div id='map'></div>
      <div id='tableSource'>
          <div class='table-source'>
          Data source: Inspections from SF Fire
          </div>
      </div>
      <div id='table'>
        <div class='no-records-message'>
          No related records for this building
        </div>
        <div class='table-wrapper'>
          <table id='relatedRecords'>
            <!-- IMPORTANT, class="list" have to be at tbody -->
            <thead>
            </thead>
            <tbody class='list'>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div id='options'>
      <div class='inner-margin'>
        <div id='geocoder'></div>
        <div class='switch-field'>
          <div class='switch-title'>Visualization</div>
          <div class='switch-input'>
            <input id='3dim' type='radio' name='maptoggle' value='3d' checked='checked' onclick='tilt(true)'>
            <label for='3dim' onclick='tilt(true)'>3D</label>
            <input id='2dim' type='radio' name='maptoggle' value='pizza' onclick='tilt(false)'>
            <label for='2dim' onclick='tilt(false)'>2D</label>
          </div>
        </div>
        <div class="loader" style='clear: both'>
          <div class='signal'></div>
          <div class='loading-text'>Loading...</div>
        </div>
        <div id='buildingInfo'>
          <div class='info-panel'>
            <div class='info-header'>
              <h1>Selected Building Information</h1>
            </div>
            <div class='info-body'>
              <div>Click on a building in the map to display related information</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id='footer'>
    <div class="text-center made-in">
      Made with <i class="fa fa-heart"><span class="sr-only">heart</span></i> in San Francisco
    </div>
  </div>
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.37.0/mapbox-gl.js'></script>
  <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.1.0/mapbox-gl-geocoder.min.js'></script>
  <script src="turf.min.js" charset="utf-8"></script>
  <script src="wellknown.js" charset="utf-8"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.3/fetch.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/es6-promise/4.1.0/es6-promise.min.js"></script>
  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiZGF0YXNmIiwiYSI6Ilo3bVlHRDQifQ.7gkiPnZtioL8CnCvJ5z9Bg'
    if (!mapboxgl.supported()) {
      alert('Your browser does not support Mapbox GL, please use a more recent browser');
    } else {
      var center = [-122.41840239268754, 37.778666100153075]
      var map = new mapboxgl.Map({
        style: 'mapbox://styles/mapbox/light-v9',
        center: center,
        zoom: 16,
        pitch: 60,
        bearing: 36,
        container: 'map'
      })

      var geocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        placeholder: 'Search map by address',
        proximity: {
          longitude: -122.41840239268754,
          latitude: 37.778666100153075
        },
        country: 'US'
      })

      document.getElementById('geocoder').appendChild(geocoder.onAdd(map))
  }
    
    // CONSTANTS
    var BASE_API = 'https://data.sfgov.org/resource/'

    // define datasets used in the app including unique id, name of geometry column, name of parcel column(s) and any select properties
    var DATASETS = {
      'fireinspections': {
        id: 'vygc-d77z',
        fbf: 'wb4c-6hwj',
        geometry: 'location',
        name: 'Fire Insepctions from SF Fire',
        select: {
          '"Fire"': 'department',
          'address': 'address',
          '"BFP District "||bfp_district': 'assigned_to',
          'inspection_number': 'inspection_number',
          'inspection_status': 'status',
          'inspection_start_date': 'start_date',
          'inspection_end_date': 'end_date',
          'inspection_type_description': 'description'
        }
      },
      'buildings': {
        id: '2s2t-jwzp',
        fbf: '72ai-zege',
        geometry: 'the_geom'
      },
      'addresses': {
        id: 'c59h-mc8k',
        fbf: 'dxjs-vqsy',
        geometry: 'location'
      },
      'parcels': {
        id: '3iun-6we5',
        fbf: '3iun-6we5',
        geometry: 'geometry',
        parcel: 'blklot'
      },
      'bldgpermits': {
        id: 'vy2q-29it',
        geometry: 'location',
        fbf: 'i98e-djp9',
        parcel: 'block||lot',
        name: 'Building permits from SF Dept of Building Inspection',
        select: {
          'permit_number': 'record_id',
          'street_number||" "||street_name||" "||street_suffix': 'address',
          '"Building Inspection"': 'issuing_department',
          'permit_type_definition': 'record_type',
          'status': 'status',
          'status_date': 'status_date',
          'description': 'description'
        }
      },
      'plancases': {
        id: 'uqai-dcpf',
        geometry: 'the_geom',
        parcel: 'apn',
        fbf: 'sqj6-g4dr',
        name: 'Planning records from SF Planning',
        select: {
          'record_id': 'record_id',
          'address': 'address',
          '"Planning"': 'issuing_department',
          'record_type': 'record_type',
          'record_status': 'status',
          'record_status_date': 'status_date',
          'description': 'description'
        },
        where: 'record_type_type+in("Applications","Research","Other","Project")'
      },
      'energy': {
        id: '75rg-imyz',
        fbf: 'j2j3-acqj',
        geometry: 'full_address',
        parcel: 'parcel_s',
        pattern: 'block_num/lot_num',
        name: 'Existing commercial buildings energy performance report from SF Environment'
      },
      'zoning': {
        id: '8br2-hhp3',
        fbf: '8br2-hhp3',
        geometry: 'geometry'
      },
      'landuse': {
        id: 'a2rp-pwkh',
        fbf: 'us3s-fp9q',
        geometry: 'the_geom'
      },
      'dbiviolations': {
        id: 'jfcn-py3d',
        fbf: 'nbtm-fbw5',
        geometry: 'location',
        parcel: 'block||lot',
        name: 'Violations from SF Dept of Building Inspection',
        select: {
          '"Building Inspection"': 'department',
          'street_number||" "||street_name||" "||street_suffix': 'address',
          'assigned_division': 'assigned_to',
          'status': 'status',
          'date_filed': 'violation_date',
          'nov_item_description': 'description',
          'complaint_number||item_sequence_number': 'violation_id',
          'complaint_number': 'inspection_or_complaint_number'
        }
      },
      'fireviolations': {
        id: 'x75j-u3wx',
        fbf: '4zuq-2cbe',
        geometry: 'location',
        name: 'Violations from SF Fire',
        select: {
          '"Fire"': 'department',
          'address': 'address',
          '"BFP District "||bfp_district': 'assigned_to',
          'close_date': 'close_date',
          'inspection_number': 'inspection_or_complaint_number',
          'status': 'status',
          'violation_date': 'violation_date',
          'violation_item_description': 'description',
          'violation_id': 'violation_id'
        }
      },
      'firecomplaints': {
        id: 'v3w9-dyka',
        fbf: '2wsq-7wmv',
        geometry: 'location',
        name: 'Fire safety complaints from SF Fire',
        select: {
          '"Fire"': 'department',
          '"BFP District "||bfp_district': 'assigned_to',
          'complaint_item_type_description': 'description',
          'address': 'address',
          'complaint_number': 'complaint_number',
          'entry_date': 'file_date',
          'inspection_number': 'inspection_number',
          '"Not Available"': 'parcel'
        }
      },
      'dbicomplaints': {
        id: 'frbs-hx9j',
        fbf: 'gm2e-bten',
        geometry: 'location',
        parcel: 'block||lot',
        name: 'Building complaints from SF Dept of Building Inspection',
        select: {
          '"Building Inspection"': 'department',
          'assigned_division': 'assigned_to',
          'complaint_description': 'description',
          'complaint_number': 'complaint_number',
          'date_filed': 'file_date',
          'street_number||" "||street_name||" "||street_suffix': 'address',
          '"N/A"': 'inspection_number'
        }
      },
      'plancomplaints': {
        id: 'uqai-dcpf',
        geometry: 'the_geom',
        parcel: 'apn',
        fbf: 'sqj6-g4dr',
        name: 'Planning records from SF Planning',
        select: {
          '"Planning"': 'department',
          'record_type_subtype': 'assigned_to',
          'record_id': 'complaint_number',
          'date_opened': 'file_date',
          'address': 'address',
          'description': 'description',
          '"N/A"': 'inspection_number'
        },
        where: 'record_type_type="Complaint"'
      },
      'cityfacilities': {
        id: 'i5wr-crji',
        fbf: 'nc68-ngbr',
        geometry: 'geom',
        parcel: 'block_lot',
        name: 'City facilities from SF City Administrator'
      },
      'propertyrolls': {
        id: 'fk72-cxc3',
        fbf: 'wv5m-vpq2',
        geometry: 'location',
        parcel: 'block_and_lot_number',
        name: 'Historic secured property tax rolls from SF Assessor-Recorder',
        select: {
          'closed_roll_assessed_fixtures_value': 'fixtures_value',
          'closed_roll_assessed_improvement_value': 'improvement_value',
          'closed_roll_assessed_land_value': 'land_value',
          'closed_roll_assessed_personal_prop_value': 'personal_property_value',
          'closed_roll_fiscal_year': 'closed_roll_fiscal_year',
          'closed_roll_homeowner_exemption_value': 'homeowner_exemption_value',
          'closed_roll_misc_exemption_value': 'misc_exemption_value',
          'current_sales_date': 'current_sales_date',
          'prior_sales_date': 'prior_sales_date',
          'property_location': 'property_location',
          'recordation_date': 'recordation_date'
        }
      }
    }

    var USECODES = {
      'cie': 'Cultural, Institutional, Educational',
      'med': 'Medical',
      'mips': 'Office (Management, Information, Professional Services)',
      'mixed': 'Mixed Uses (Without Residential)',
      'mixres': 'Mixed Uses (With Residential)',
      'pdr': 'Industrial (Production, Distribution, Repair)',
      'retail/ent': 'Retail, Entertainment',
      'retail': 'Retail, Entertainment',
      'resident': 'Residential',
      'visitor': 'Hotels, Visitor Services',
      'vacant': 'Vacant',
      'row': 'Right-of-Way',
      'openspace': 'Open Space'
    }

    var USESQFT = ['cie', 'med', 'mips', 'retail', 'pdr', 'visitor']

    // state variables
    var state = {}
    var emptyGeojson = {
      "type": "FeatureCollection",
      "features": []
    }
    var popup = new mapboxgl.Popup({
      closeButton: false,
      closeOnClick: false,
      anchor: 'top-left',
      offset: 10
    })

    function addBuildings(data) {
      map
        .addSource('buildings', {
          'type': 'geojson',
          'data': data
        })
        .addSource('highlight', {
          'type': 'geojson',
          'data': emptyGeojson
        })
        .addSource('selected', {
          'type': 'geojson',
          'data': emptyGeojson
        })
        .addSource('single-point', {
          'type': 'geojson',
          'data': emptyGeojson
        })

      map
        .addLayer({
          'id': 'buildings-3d',
          'type': 'fill-extrusion',
          'source': 'buildings',
          'minzoom': 15,
          'paint': {
            'fill-extrusion-color': '#aaa',
            'fill-extrusion-height': {
              'type': 'identity',
              'property': 'height'
            },
            'fill-extrusion-opacity': 0.8
          }
        })
        .addLayer({
          'id': 'buildings-2d',
          'type': 'fill',
          'source': 'buildings',
          'minzoom': 15,
          'paint': {
            'fill-color': '#aaa',
            'fill-opacity': 0
          }
        })
        .addLayer({
          'id': 'highlighted_fill',
          'type': 'line',
          'source': 'highlight',
          'minzoom': 15,
          'paint': {
            'line-color': 'orange'
          }
        })
        .addLayer({
          'id': 'highlighted_extrusion',
          'type': 'fill-extrusion',
          'source': 'highlight',
          'minzoom': 15,
          'paint': {
            'fill-extrusion-color': 'orange',
            'fill-extrusion-height': {
              'type': 'identity',
              'property': 'height'
            },
            'fill-extrusion-opacity': 0.5
          }
        })
        .addLayer({
          'id': 'selected_fill',
          'type': 'fill',
          'source': 'selected',
          'minzoom': 15,
          'paint': {
            'fill-color': 'red'
          }
        })
        .addLayer({
          'id': 'selected_extrusion',
          'type': 'fill-extrusion',
          'source': 'selected',
          'minzoom': 15,
          'paint': {
            'fill-extrusion-color': 'red',
            'fill-extrusion-height': {
              'type': 'identity',
              'property': 'height'
            },
            'fill-extrusion-opacity': 0.5
          }
        })
        .addLayer({
          "id": "point",
          "source": "single-point",
          "type": "circle",
          "paint": {
              "circle-radius": 10,
              "circle-color": "#007cbf"
          }
        })

      loaderOff()
    }

    function updateBuildings(data) {
      map.getSource('buildings').setData(data)
      loaderOff()
    }

    function searchForArray(haystack, needle) {
      var i, j, current
      for (i = 0; i < haystack.length; ++i) {
        if (needle.length === haystack[i].length) {
          current = haystack[i]
          for (j = 0; j < needle.length && needle[j] === current[j]; ++j) { }
          if (j === needle.length) return i
        }
      }
      return -1
    }

    function generateSel(select) {
      return Object.keys(select).map(function (key) {
        return key + '+as+' + select[key]
      }).join(',')
    }

    function fetchData(q, name, data) {
      name = name || 'data'
      data = data || {}
      var resType = q['return'] || 'json'
      var baseQuery = BASE_API + q['id'] + '.' + resType + '?$select='
      if (q.select) {
        baseQuery += generateSel(q.select)
      } else {
        baseQuery += '*'
      }
      baseQuery += (q.parcel && q.parcel !== 'parcel') ? ',' + q.parcel + '+as+parcel' : ''
      baseQuery += (q.geometry && q.geometry !== 'geometry') ? ',' + q.geometry + '+as+geometry' : ''

      // where statement, either by geometry or parcel ID
      var alt = typeof q.pattern !== 'undefined'
      baseQuery += q.wkt ? '&$where=intersects(geometry,"' + q.wkt + '")' : '&$where=' + whereParcelEq(alt)

      if(q.where) {
        baseQuery += '+and+' + q.where
      }

      // additional optional query string
      baseQuery += q.query ? '&' + q.query : ''

      return fetch(baseQuery)
        .then(function (res) {
          if (!res.ok) return { error: true }
          return res.json().then(function (json) {
            return Object.assign({}, data, {
              [name]: json
            })
          })
        })
    }

    function whereParcelEq(alt) {
      if (alt) return whereParcelBlockSlashLot()

      return state.parcels.map(function (parcel) {
        return 'parcel="' + parcel.blklot + '"'
      }).join('+or+')
    }

    function whereParcelBlockSlashLot() {
      return state.parcels.map(function (parcel) {
        return 'parcel="' + parcel.block_num + '/' + parcel.lot_num + '"'
      }).join('+or+')
    }

    function wktFromPolygon(data, geomName) {
      var WKT = wellknown.stringify(data[geomName])
      if (WKT.length > 1200) {
        WKT = wellknown.stringify(turf.simplify(data[geomName],0.000001,false))
      }
      return WKT
    }

    function wktFromPoints(data, geomName) {
      if (data.length === 0) return false

      var points = []
      if (data.length > 1) {
        data.forEach(function (record, idx) {
          var coords = record[geomName].coordinates
          if (searchForArray(points, coords) === -1) {
            points.push(coords)
          }
        })
      } else {
        points.push(data[0].location.coordinates)
      }
      var geometry = points.length > 1 ? turf.lineString(points) : turf.point(points[0])
      var WKT = wellknown.stringify(geometry)
      return WKT
    }

    function formatDate(date) {
      var eightchar = /^[0-9]{8}/
      var iso = /^[0-9]{4}-[0-9]{2}-[0-9]{2}T/
      var slashes = /^[0-9]{1,2}\/[0-9]{1,2}\/[0-9]{4}/
      if (iso.test(date)) {
        return date.split('T')[0]
      }
      if (!date) {
        return ' '
      }
      if (eightchar.test(date)) {
        return date.substr(0, 4) + '-' + date.substr(4, 2) + '-' + date.substr(6, 2)
      }
      if (slashes.test(date)) {
        var parts = date.split('/')
        return parts[2] + '-' + (parts[0].length == 2 ? parts[0] : '0' + parts[0]) + '-' + (parts[1].length == 2 ? parts[1] : '0' + parts[1])
      }
    }

    function formatMoney(money) {
      if (!money) return ''
      
      return '$' + Number(money).toLocaleString('en-US')
    }

    function formatRecords(headers, records) {
      // collect fields for normalization
      var fields = headers.filter(function(header){
        return header.indexOf('_date') > -1 || header.indexOf('_value') > -1
      })
      var numFields = fields.length
      if (numFields === 0) return records

      var numRecords = records.length
      var i = 0
      var formatted = []
      for (i; i < numRecords; i++) {
        var j = 0
        formatted.push(records[i])
        for (j; j < numFields; j++) {
          if (fields[j].indexOf('_date') > -1) {
            formatted[i][fields[j]] = formatDate(formatted[i][fields[j]])
          } else if (fields[j].indexOf('_value') > -1) {
            formatted[i][fields[j]] = formatMoney(formatted[i][fields[j]])
          }
        }
      }
      return formatted
    }

    function onSelectRelated(type) {
      loaderOn()
      var TYPES = {
        'permits': {
          'datasets': ['bldgpermits', 'plancases'],
          'headers': ['issuing_department','record_id','record_type','status','status_date','parcel','address','description'],
          'defaultSort': ['status_date']
        },
        'inspections': {
          'datasets': ['fireinspections'],
          'headers': ['department', 'assigned_to', 'inspection_number', 'start_date', 'end_date', 'status', 'description'],
          'defaultSort': ['start_date']
        },
        'propertytax': {
          'datasets': ['propertyrolls'],
          'headers': ['property_location', 'parcel', 'closed_roll_fiscal_year', 'current_sales_date', 'prior_sales_date', 'recordation_date', 'land_value', 'improvement_value', 'fixture_value', 'homeowner_exemption_value', 'misc_exemption_value'],
          'defaultSort': ['closed_roll_fiscal_year']
        },
        'complaints': {
          'datasets': ['firecomplaints', 'dbicomplaints', 'plancomplaints'],
          'headers': ['department', 'assigned_to', 'complaint_number', 'inspection_number', 'file_date', 'parcel', 'address', 'description'],
          'defaultSort': ['file_date']
        },
        'violations': {
          'datasets': ['fireviolations', 'dbiviolations'],
          'headers': ['department', 'assigned_to', 'violation_id', 'inspection_or_complaint_number', 'violation_date', 'status', 'parcel', 'address', 'description'],
          'defaultSort': ['violation_date']
        },
        'energy': {
          'datasets': ['energy'],
          'headers': ['building_address', 'building_name', 'parcel', 'energy_audit_due_date', 'energy_audit_status', 'floor_area', 'property_type_self_selected']
        }
      }
      var cb = 'process' + type

      Promise.all(TYPES[type].datasets.map(function (param) {
        var q = DATASETS[param]
        if (!q.parcel) q.wkt = state.parcelIntersect
        return fetchData(q, type)
      }))
        .then(function (values) {
          values = values.reduce(function (prev, curr) {
            return prev.concat(curr[type])
          }, [])
          return values
        })
        .then(function (json) {
          loaderOff()
          renderTable(json, TYPES[type].headers, TYPES[type].defaultSort, TYPES[type].datasets)
        })
    }


    function onHoverBuilding(e) {
      var ft = data = queryFeatures(e.point, null)

      if (map.getZoom() > 17 && ft) {
        var queryBox = [[e.point.y - 500, e.point.x - 500], [e.point.y + 500, e.point.x + 500]]
        data = queryFeatures(null, ft.properties.id)
      } 

      if (ft) {
        map.getSource('highlight').setData(data)
      } else {
        map.getSource('highlight').setData(emptyGeojson)
      }

      var showTooltip = ft && e.originalEvent.which === 0

      if (showTooltip) {
        var html = '<strong>Building ID:</strong> ' +
          ft.properties.id +
          '<p>Click to select and query features</p>'
        map.getCanvas().style.cursor = 'pointer'
        popup.setLngLat(e.lngLat)
          .setHTML(html)
          .addTo(map)
      } else {
        map.getCanvas().style.cursor = ''
        popup.remove()
      }
    }

    function loaderOff () {
      document.querySelector('.loader').classList.add('hidden')
    }

    function loaderOn () {
      document.querySelector('.loader').classList.remove('hidden')
    }

    function closeTable () {
      document.querySelector('#main').classList.add('table-hidden')
    }

    function openTable () {
      document.querySelector('#main').classList.remove('table-hidden')
    }

    function queryFeatures(query, id) {
      var options = {layers: ['buildings-2d']}
      if (id) options.filter = ['==', 'id', id]

      var features = id ? map.queryRenderedFeatures(options) : map.queryRenderedFeatures(query, options)
      var data = features[0]
      if (features.length > 1) {
        data = {
          type: 'Feature', 
          geometry: features[0].geometry,
          properties: features[0].properties
        }
        for (var i=1, len=features.length; i < len; i++) {
          data = turf.union({
            type: 'Feature',
            geometry: features[i].geometry,
            properties: features[i].properties
          }, data)
        }
      }      
      return data
    }

    function onSelectBuilding(ft) {
      if (ft) {
        closeTable()
        loaderOn()
        map.getSource('selected').setData(ft)
        map.getSource('highlight').setData(emptyGeojson)
        var addresses = DATASETS['addresses']
        addresses.wkt = wellknown.stringify(ft)
        if (addresses.wkt.length > 1200) {
          // simplify the complex shapes for smaller uri payload
          addresses.wkt = wellknown.stringify(turf.simplify(ft, 0.0001, false))
        }
        addresses.query = '$order=address,unit_number'
        var parcels = DATASETS['parcels']
        parcels.query = '$order=map_add+desc'

        fetchData(addresses, 'addresses')
          .then(function (json) {
            parcels.wkt = json.addressIntersect = wktFromPoints(json.addresses, 'geometry')
            if (!parcels.wkt) {
              parcels.wkt = wellknown.stringify(turf.centerOfMass(ft))
            }
            if (typeof json.addressIntersect === 'string') {
              return fetchData(parcels, 'parcels', json)
            } else {
              return fetchData(parcels, 'parcels', json).then(function (json) {
                addresses.wkt = json.parcelIntersect = wktFromPolygon(json.parcels[0], 'geometry')
                json.addressIntersect = parcels.wkt
                return fetchData(addresses, 'addresses', json)
              })
            }
          })
          .then(function (json) {
            json.parcelIntersect = json.parcelIntersect || wktFromPolygon(json.parcels[0], 'geometry')
            var landuse = DATASETS['landuse']
            var zoning = DATASETS['zoning']
            var facility = DATASETS['cityfacilities']
            landuse.wkt = zoning.wkt = json.addressIntersect
            facility.wkt = json.parcelIntersect
            Promise.all([
              fetchData(landuse, 'landuse'),
              fetchData(zoning, 'zoning'),
              fetchData(facility, 'facility')
            ])
              .then(function (values) {
                return Object.assign({}, json, values[0], values[1], values[2], { 'building': ft['properties'] })
              })
              .then(function (json) {
                state = Object.assign({}, state, json)
                loaderOff()
                renderBuildingInfo(json)
              })
          })
      }
    }

    function tilt(on) {
      var pitch = !on ? 0 : 60

      if (!on) {
        map.setPaintProperty('buildings-3d', 'fill-extrusion-opacity', 0)
        map.setPaintProperty('buildings-2d', 'fill-opacity', 0.8)
      } else {
        map.setPaintProperty('buildings-3d', 'fill-extrusion-opacity', 0.8)
        map.setPaintProperty('buildings-2d', 'fill-opacity', 0)
      }

      map.easeTo({ pitch })
    }

    function updateOnMove(e) {
      if (turf.distance(center, map.getCenter().toArray(), 'miles') >= .75) {
        center = map.getCenter().toArray()
        loadData(false)
      }
    }

    // rendering functions to display related tables and building information
    function parseHeaderName(name) {
      name = name.replace(/_/g,' ')
      name = name.replace(/\b\w/g, function(l){ return l.toUpperCase() })
      return name
    }

    function renderTable(records, headers, defaultSort, datasets) {
      var mainElem = document.querySelector('#main')
      var tableElem = document.querySelector('#table')
      var sourceElem = document.querySelector('#tableSource .table-source')
      mainElem.classList.remove('table-hidden')
      tableElem.classList.remove('no-records')
      if(records.length > 0) {
        var keys = headers ? headers : Object.keys(records[0])

        var headers = '<tr>' + keys.map(function (key) {
          return '<th class=' + key + '>' + parseHeaderName(key) + '</th>'
        }).join('') + '</tr>'

        var template = '<tr>' + keys.map(function (key) {
          return '<td class=' + key + '></td>'
        }).join('') + '</tr>'

        var options = {
          valueNames: keys,
          item: template
        }

        records = formatRecords(keys, records)

        document.querySelector('#relatedRecords thead').innerHTML = headers
        sourceElem.innerHTML = 'Data source(s): ' + renderTableSource(datasets)
        var table = new List('table', options)
        table.clear()
        table.add(records)
        table.sort(defaultSort[0], {
          order: 'desc'
        })
      } else {
        tableElem.classList.add('no-records')
        sourceElem.innerHTML = ''
      }
    }

    function renderBuildingInfo(data) {
      var body
      var sections = []
      // Buttons
      sections.push(renderButton('Show permits and planning apps.', 'permits'))
      sections.push(renderButton('Show historic property tax rolls', 'propertytax'))
      sections.push(renderButton('Show inspections', 'inspections'))
      sections.push(renderButton('Show complaints', 'complaints'))
      sections.push(renderButton('Show violations', 'violations'))
      sections.push(renderButton('Show commercial bldg. energy audit', 'energy'))

      // General Characteristics info
      var building = data.building
      var landuse = data.landuse[0]
      var facility = data.facility
      body = '<div>Building ID: ' + building.id + '</div>'
      body += '<div>Median height (derived fr. LIDAR): ' + building.height + ' m (' + Math.round(building.height * 328.084) / 100 + ' ft)</div>'
      sections.push(renderInfoSection('General Characteristics', body))
      sections.push(renderDataSource(DATASETS['buildings'].fbf, 'Building Footprints from SF Dept of Tech'))
      if (facility) 

      // City Facilities info
      if (facility.length > 0) {
        body = ''

        for (var i = 0, len = facility.length; i < len; i++) {
          var leaseOwn = facility[i].owned_leased === 'Own' ? 'owned' : 'leased'
          body += '<div class="facility">' + facility[i].address + ' ' + leaseOwn + ' by ' + facility[i].department_name + '</div>'
        }
        sections.push(renderInfoSection('City Facilities', body))
        sections.push(renderDataSource(DATASETS['cityfacilities'].fbf, 'City Facilities from SF City Administrator'))
      }
      // Zoning info
      var zoning = data.zoning[0]
      var codeArray = zoning.url.split('_')
      var code = codeArray[codeArray.length - 1]
      var link = '<a href="' + zoning.url + '">SF Planning Code Section ' + code + '</a>'
      body = '<div>' + zoning.zoning + ', District: ' + zoning.districtna + ' ' + zoning.gen + ' ' + link
      sections.push(renderInfoSection('Zoning', body))
      sections.push(renderDataSource(DATASETS['zoning'].fbf, 'Zoning Districts from SF Planning'))

      // Land use info
      body = '<div>Primary land use: ' + USECODES[landuse.landuse.toLowerCase()] + '</div>'
      body += '<div>Est. Year Built: ' + landuse.yrbuilt + '</div>'
      if (landuse.resunits) body += '<div>Est. Residential Units: ' + landuse.resunits + '</div>'

      // Land use table
      body += '<table class="small-table"><caption>Square footage by land use type*</caption><thead><th>Land use type</th><th>Est. Square Footage</th></thead>'
      var rows = Object.keys(landuse).filter(function (key) {
        return USESQFT.indexOf(key) > -1
      }).map(function (key) {
        return '<tr><td class="use">' + USECODES[key.toLowerCase()] + '</td><td class="sqft">' + Number(landuse[key]).toLocaleString() + '</td></tr>'
      }).join('')
      body += '<tbody>' + rows + '</tbody>'
      body += '<tfoot><tr><td>Total</td><td>' + Number(landuse.total_uses).toLocaleString() + '</td></tr></table>'
      body += '<p class="advisory">*Land use square footage data are derived from a variety of sources, subject to errors and ommissions.</p>'
      sections.push(renderInfoSection('Land Use', body))
      sections.push(renderDataSource(DATASETS['landuse'].fbf, 'Land Use from SF Planning'))

      // Associated addresses
      var addresses = data.addresses
      var list = addresses.map(function (elem) {
        var address = elem.address + (elem.unit_number ? ' Unit ' + elem.unit_number : '')
        return '<li>' + address + '</li>'
      }).join('')
      body = '<ul class="not-styled">' + list + '</ul>'
      sections.push(renderInfoSection('Associated Addresses', body))
      sections.push(renderDataSource(DATASETS['addresses'].fbf, 'Enterprise Addresses with Units from SF Dept of Tech'))

      // Associated parcels
      var parcels = data.parcels
      var list = parcels.map(function (elem) {
        var hist = elem.rec_drop ? ' (dropped ' + elem.rec_drop + ')' : ' (added ' + (elem.rec_add || ' on unknown date') + ')'
        return '<li>' + elem.blklot + hist + '</li>'
      }).join('')
      body = '<ul class="not-styled">' + list + '</ul>'
      sections.push(renderInfoSection('Associated Parcels', body))
      sections.push(renderDataSource(DATASETS['parcels'].fbf, 'Recorded Parcel Geography from SF Dept of Tech'))

      // replace building info
      document.querySelector('#buildingInfo .info-body').innerHTML = sections.join('')
    }

    function renderButton(title, type) {
      return "<button class='button-primary' onclick='onSelectRelated(\"" + type + "\")'>" + title + "</button>"
    }

    function renderInfoSection(title, body) {
      return "<div class='info-section'><h2>" + title + "</h2>" + body
    }

    function renderDataSource(id, name) {
      return "<div class='data-source'><a target='_blank' href='https://data.sfgov.org/d/" + id + "'>Data source: " + name + "</a></div>"
    }

    function renderTableSource(datasets) {
      var i = 0
      var num = datasets.length
      var links = []
      for (var i; i < num; i++) {
        var dataset = DATASETS[datasets[i]]
        links.push("<a href='https://data.sfgov.org/d/" + dataset.fbf + "' target='_blank'>" + dataset.name + "</a>")
      }
      return links.join(', ')
    }

    function loadData(init) {
      loaderOn()
      var mapBounds = map.getBounds()
      var poly = {
        'type': 'Feature',
        'properties': {},
        'geometry': {
          'type': 'Polygon',
          'coordinates': [[mapBounds.getNorthWest().toArray(), mapBounds.getNorthEast().toArray(), mapBounds.getSouthEast().toArray(), mapBounds.getSouthWest().toArray(), mapBounds.getNorthWest().toArray()]]
        }
      }

      var buffered = turf.buffer(poly, 0.5, 'miles')
      var bbox = turf.bbox(buffered)
      // Socrata API returns the numeric columns as strings, we have to cast the ones we want to use in the extrusion as float
      fetch('https://data.sfgov.org/resource/2s2t-jwzp.geojson?$select=sf16_bldgid+as+id,hgt_median_m+as+height,the_geom&$limit=10000000&$where=within_box(the_geom,' + bbox[1] + ', ' + bbox[0] + ', ' + bbox[3] + ', ' + bbox[2] + ')&$order=objectid').then(function (response) {
        response.json().then(function (json) {
          json['features'] = json['features'].map(function (feature, idx) {
            feature.properties.height = parseFloat(feature.properties.height)
            return feature
          })
          init ? addBuildings(json) : updateBuildings(json)
        })
      })
    }
    map.on('load', function () {
      map.setLayoutProperty('building', 'visibility', 'none')
      map.setPaintProperty('parks', 'fill-color', '#A5DC86')
      loadData(true)

      map.on('mousemove', onHoverBuilding)
      map.on('click', function (e) {
        var feature = queryFeatures(e.point)
        feature = map.getZoom() > 17 ? queryFeatures(null, feature.properties.id) : feature
        onSelectBuilding(feature)
      })
      map.on('dragend', updateOnMove)
      map.on('zoomend', updateOnMove)
    })

    geocoder.on('result', function (e) {
      var geocodeWKT = wellknown.stringify(e.result.geometry)
      var text = e.result.text
      // normalize directions to improve matches with addresses
      var dirMapping = {
        'N': 'north',
        'S': 'south',
        'E': 'east',
        'W': 'west'
      }
      var firstPos = e.result.text.split(' ')[0]
      if (Object.keys(dirMapping).indexOf(firstPos) > -1) {
        text = e.result.text.replace(firstPos, dirMapping[firstPos])
      }
      // lookup geo by address text string
      fetch(BASE_API + DATASETS['addresses'].id + '.geojson?$select=*,lower(address)&$where=lower_address="' + e.result.address + ' ' + text.toLowerCase() + '"')
        .then(function (res) {
          res.json().then(function (addressJson) {
            if (addressJson.features.length > 0) {
              fetch(BASE_API + DATASETS['buildings'].id + '.geojson?$select=sf16_bldgid+as+id,hgt_median_m+as+height,the_geom&$where=intersects(the_geom, "' + wellknown.stringify(addressJson.features[0]) + '")')
                .then(function (res) {
                  res.json().then(function (json) {
                    if (json.features.length > 0) {
                      json.features[0].properties.height = Number(json.features[0].properties.height)
                      onSelectBuilding(json.features[0])
                      map.getSource('single-point').setData(emptyGeojson)
                    } else {
                      map.getSource('selected').setData(emptyGeojson)
                      map.getSource('single-point').setData(addressJson.features[0])
                    }
                  })
                })
            } else {
              map.getSource('selected').setData(emptyGeojson)
              map.getSource('single-point').setData(e.result.geometry)
            }
          })
        })
    })

  </script>

</body>

</html>